jQuery(document).ready(function($){"use strict";function zoomChart(){var a=top_sales_by_date_chart.dataProvider.length;a>30&&top_sales_by_date_chart.zoomToIndexes(a-30,a-1)}function get_dashboard_data(from,to){block($("#pafw-dashboard-wrapper")),$.ajax({type:"post",dataType:"json",url:ajaxurl,data:{action:_pafw_sales.action,command:"get_data",date_from:from,date_to:to,interval:$(".search-interval.selected").data("interval")},success:function(response){response.success?($.each(response.data,function(key,value){var fn="process_"+key;eval("typeof "+fn+" == 'function'")&&eval(fn)(value)}),zoomChart(),unblock($("#pafw-dashboard-wrapper"))):(alert(response.data.message),unblock($("#pafw-dashboard-wrapper")))},error:function(){unblock($("#pafw-dashboard-wrapper"))}})}function process_order_stat_by_date(a){_.find(top_sales_by_date_chart.graphs,function(a){return"amount"===a.id}).title=$(".search-interval.selected").data("amount_label"),top_sales_by_date_chart.dataProvider=a,AmCharts.applyGapValue.processData(top_sales_by_date_chart,!0)}function process_order_stat_by_day_of_week(a){sales_by_day_of_week_chart.dataProvider=a,sales_by_day_of_week_chart.validateData()}function process_order_stat_by_hour(a){for(var b=[],c=0;c<24;c++)b.push({hour:c,value:"0",count:"0"});$.each(a,function(a,c){b[parseInt(c.hour)].value=c.value,b[parseInt(c.hour)].count=c.count}),sales_by_hour_chart.dataProvider=b,sales_by_hour_chart.validateData()}function process_order_stat_by_order_status(a){$(".pafw-dashboard-stat .pafw-order-status .count").html("0"),$(".pafw-dashboard-stat .pafw-order-status .amount").html("0"),$.each(a,function(a,b){$(".pafw-dashboard-stat ."+b.order_status+" .count").html(b.count),$(".pafw-dashboard-stat ."+b.order_status+" .amount").html(b.amount)}),sales_by_hour_chart.validateData()}var date_from="",date_to="",is_blocked=function(a){return a.is(".processing")||a.parents(".processing").length},block=function(a){is_blocked(a)||a.addClass("processing").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock=function(a){a.removeClass("processing").unblock()};AmCharts.addInitHandler(function(a){void 0!==a.applyGapValue&&void 0!==a.categoryAxis&&!0===a.categoryAxis.parseDates&&AmCharts.applyGapValue.processData(a,!1)},["serial"]),AmCharts.applyGapValue={getDate:function(a,b){return"string"==typeof a&&void 0!==b?AmCharts.stringToDate(a,b):new Date(a)},formatDate:function(a,b,c){return"string"==typeof b&&void 0!==c?AmCharts.formatDate(a,c):"number"==typeof b?a.getTime():a},getPeriod:function(a){a=a||"DD";var b=AmCharts.extractPeriod(a);return AmCharts.getPeriodDuration(b.period,b.count)},addPeriod:function(a,b,c){b=b||"DD";var d=AmCharts.extractPeriod(b),e=new Date(a);switch(d.period){case"YYYY":e.setFullYear(e.getFullYear()+c);break;case"MM":e.setFullYear(e.getFullYear(),e.getMonth()+c);break;case"DD":e.setFullYear(e.getFullYear(),e.getMonth(),e.getDate()+c);break;case"hh":e.setHours(e.getHours()+c);break;case"mm":e.setHours(e.getHours(),e.getMinutes()+c);break;case"ss":e.setHours(e.getHours(),e.getMinutes(),e.getSeconds()+c);break;case"fff":e.setTime(e.getTime()+c)}return e},processData:function(a,b){var c=0,d=a.dataProvider,e=a.categoryField,f=a.dataDateFormat;if(AmCharts.ifArray(d)&&0!==d.length){for(var g=(AmCharts.applyGapValue.getDate(d[0][e],f),AmCharts.applyGapValue.getDate(d[d.length-1][e],f),d[0][e]),h=[],i=0;i<d.length;i++)if(!0===a.accumulateValue&&(c+=parseFloat(d[i].value),d[i].acc_value=c),h.push(d[i]),i+1<d.length)for(var j=d[i+1],k=AmCharts.applyGapValue.getDate(j[e]),l=AmCharts.applyGapValue.addPeriod(AmCharts.applyGapValue.getDate(d[i][e]),a.categoryAxis.minPeriod,a.pafwGapValue);l<k;){var m={};m[e]=AmCharts.applyGapValue.formatDate(l,g,a.dataDateFormat);for(var n=0;n<a.graphs.length;n++)!0===a.accumulateValue?(m[a.graphs[n].valueField]=a.applyGapValue,m.acc_value=c):m[a.graphs[n].valueField]=a.applyGapValue;h.push(m),l=AmCharts.applyGapValue.addPeriod(l,a.categoryAxis.minPeriod,a.pafwGapValue)}a.dataProvider=h,b&&a.validateData()}}};var top_sales_by_date_chart=AmCharts.makeChart("top_sales_by_date_chart",{type:"serial",theme:"light",applyGapValue:0,pafwGapValue:1,accumulateValue:!0,legend:{useGraphSettings:!0,markerSize:10,valueText:"",valueWidth:0},addClassNames:!0,startDuration:1,mouseWheelZoomEnabled:!1,dataDateFormat:"YYYY-MM-DD",valueAxes:[{id:"v1",axisAlpha:0,position:"left"},{id:"accAxis",axisAlpha:0,gridAlpha:0,position:"right",title:"누적"}],balloon:{borderThickness:1,shadowAlpha:0},graphs:[{id:"amount",fillAlphas:1,valueField:"value",balloonText:"<span style='font-size:10px;'>[[title]] <span style='font-size:12px; font-weight: bold;'>"+_pafw_sales.currency+"[[value]]</span> [[additional]]</span>",type:"column",clustered:!1,title:"당일매출"},{id:"amount_sum",type:"smoothedLine",valueField:"acc_value",balloonText:"<span style='font-size:10px;'>[[title]] <span style='font-size:12px; font-weight: bold;'>"+_pafw_sales.currency+"[[value]]</span> [[additional]]</span>",title:"누적매출",valueAxis:"accAxis",bullet:"round",bulletBorderAlpha:1,bulletColor:"#FFFFFF",bulletSize:5,hideBulletsCount:50,lineThickness:2,useLineColorForBulletBorder:!0}],chartScrollbar:{graph:"amount",oppositeAxis:!1,offset:10,scrollbarHeight:40,dragIconHeight:20,backgroundAlpha:0,selectedBackgroundAlpha:.1,selectedBackgroundColor:"#888888",graphFillAlpha:0,graphLineAlpha:.5,selectedGraphFillAlpha:0,selectedGraphLineAlpha:1,autoGridCount:!1,color:"#AAAAAA"},chartCursor:{pan:!0,valueLineEnabled:!0,valueLineBalloonEnabled:!0,cursorAlpha:1,cursorColor:"#258cbb",limitToGraph:"amount",valueLineAlpha:.2,valueZoomable:!0},categoryField:"date",categoryAxis:{equalSpacing:!0,parseDates:!0,dashLength:1,minorGridEnabled:!0},export:{enabled:!0,exportTitles:!0,exportFields:["date","value","acc_value"],fileName:"pgall"},dataProvider:[]}),sales_by_day_of_week_chart=AmCharts.makeChart("sales_by_day_of_week_chart",{type:"pie",theme:"light",valueField:"value",titleField:"day_of_week",balloon:{fixedPosition:!0},balloonText:"[[title]]: [[percents]]% ([[value]], [[count]]건)",marginTop:15,marginBottom:15,marginLeft:0,marginRight:0,pullOutRadius:0,dataProvider:[]}),sales_by_hour_chart=AmCharts.makeChart("sales_by_hour_chart",{type:"serial",theme:"light",graphs:[{id:"g1",type:"column",fillAlphas:.8,lineAlpha:.2,title:"매출액",useLineColorForBulletBorder:!0,valueField:"value",balloonText:"<span style='font-size:10px;'>[[title]] <span style='font-size:12px; font-weight: bold;'>[[value]]</span></span>",valueAxis:"distanceAxis"},{id:"count_graph",type:"smoothedLine",title:"건수",bullet:"round",bulletBorderAlpha:1,bulletColor:"#FFFFFF",bulletSize:5,hideBulletsCount:50,lineThickness:2,useLineColorForBulletBorder:!0,valueField:"count",balloonText:"<span style='font-size:10px;'>[[title]] <span style='font-size:12px; font-weight: bold;'>[[value]]</span></span>",valueAxis:"countAxis"}],valueAxes:[{id:"amount",axisAlpha:0,position:"left"},{id:"countAxis",axisAlpha:0,gridAlpha:0,position:"right",title:"건수"}],chartCursor:{pan:!0,valueLineEnabled:!0,valueLineBalloonEnabled:!0,cursorAlpha:1,cursorColor:"#258cbb",valueLineAlpha:.2},categoryField:"hour",categoryAxis:{dashLength:1,equalSpacing:!0,minorGridEnabled:!0},dataProvider:[]});$("#reportrange").daterangepicker({locale:{format:"YYYY-MM-DD",separator:" - ",applyLabel:"적용",cancelLabel:"취소",fromLabel:"시작일자",toLabel:"끝일자",customRangeLabel:"범위선택",weekLabel:"W",daysOfWeek:["일","월","화","수","목","금","토"],monthNames:["1월","2월","3월","4월","5월","6월","7월","8월","9월","10월","11월","12월"],firstDay:1},alwaysShowCalendars:!0,opens:"right",startDate:_pafw_sales.start_date,endDate:_pafw_sales.end_date,maxDate:moment(),ranges:{"지난 30일":[moment().subtract(29,"days"),moment()],"지난 90일":[moment().subtract(89,"days"),moment()],"지난 180일":[moment().subtract(179,"days"),moment()],"이번달":[moment().startOf("month"),moment().endOf("month")],"지난달":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")]}}),$("#reportrange").on("apply.daterangepicker",function(a,b){date_from=$("#reportrange").data("daterangepicker").startDate.format("YYYY-MM-DD"),date_to=$("#reportrange").data("daterangepicker").endDate.format("YYYY-MM-DD"),$("#reportrange span").html(date_from+" - "+date_to),get_dashboard_data(date_from,date_to)}.bind(this)),date_from=_pafw_sales.start_date,date_to=_pafw_sales.end_date,get_dashboard_data(_pafw_sales.start_date,_pafw_sales.end_date),$(".search-interval").on("click",function(){var a=$(this).data("interval"),b=$(this).data("gap_value");top_sales_by_date_chart.pafwGapValue=b,top_sales_by_date_chart.categoryAxis.minPeriod="1M"==a?"MM":"DD",$(".search-interval").removeClass("selected"),$(".search-interval[data-interval="+a+"]").addClass("selected"),$("#reportrange").trigger("apply.daterangepicker")})});